
# MTU与IP分片

最大传输单元（Maximum Transmission Unit，MTU）是指一种通信协议的某一层上面所能通过的最大数据报大小（以字节为单位）。最大传输单元这个参数通常与通信接口有关（例如网络接口卡、串口等）。

## IP分片机制

在IP网络中，数据包可能需要跨多个网络进行传输，而每个网络的MTU值可能不同。为了确保数据报能够在所有路径上传输，**因特网协议（IP）允许IP分片**。分片的目的是将数据报分割成足够小的片段，以通过最大传输单元（MTU）小于该数据报原始大小的链路。这个过程发生在**IP层**（OSI模型的第三层，即网络层）。当数据包的大小超过链路的MTU时，IP层就会将数据包分成多个片段。

## 分片的工作方式

当数据报被分片后，每个片段会保留原始数据报的头部信息，并且在头部中加入分片标记和偏移信息，帮助目的主机重组数据报。**IP头部中的标记位和偏移字段**用于表示分片的顺序和大小，从而确保目的主机在接收到所有分片后，能够正确地将其重组成原始的完整数据报。

例如，在IPv4中，IP头部中的16位总长度字段可以表示的数据报最大长度为65535字节（即64KB）。尽管如此，常见的网络接口（如以太网）的MTU值为1500字节，这就意味着，当IP层传输大于1500字节的数据报时，必须将其分片处理。

## 路径MTU

在因特网中，每条传输路径可能包含多个网络设备，每个设备的MTU值可能不同。IP协议引入了**路径MTU（Path MTU）**的概念，它定义了从源地址到目的地址经过的所有链路中**最小的MTU值**。路径MTU的最小值决定了在该路径上传输时无需分片的数据报的最大大小。

## 实验：通过ping命令演示IP分片

为了深入理解IP分片的工作机制，我们可以通过`ping`命令进行实验。在这个实验中，我们将发送ICMP请求报文，并观察其分片行为。

首先，我们尝试发送一个不会触发分片的ICMP报文：

```bash
ping 10.104.4.1 -l 1472
```

在该命令中，`-l 1472`表示ICMP数据段的大小为1472字节。由于ICMP报文头部为8字节，IP头部为20字节，所以整个数据报的总长度为1472 + 8 + 20 = 1500字节，刚好与以太网的MTU值相同，因此不会发生分片。可以通过查看ICMP包的IP头部中的**标志位（Flag）**确认这一点，其中"**more fragment**"标志位未设置，表明没有分片。

接下来，我们增加1个字节的数据，使数据包的总长度超过MTU：

```bash
ping 10.104.4.1 -l 1473
```

由于数据报长度为1473 + 8 + 20 = 1501字节，超过了以太网的MTU，因此需要分片处理。此时，IP层将数据报分成两个片段，第一片的大小为1480字节（20字节的IP头部，8字节的ICMP头部，1472字节的数据），第二片包含剩余的1字节数据。

通过抓包工具可以观察到，第一片的**Flag位**中“more fragment”被设置为1，表示后续还有片段。**片偏移**（Fragment Offset）字段表明这是第一个片段。第二片的大小为35字节，其中去掉14字节的以太网头部和20字节的IP头部后，数据部分仅剩下1字节（这是剩余的数据）。这个1字节的数据以十六进制显示为`61`，对应ASCII字符'a'。

## 分片重组

IP分片的另一个重要特性是，目的主机会对所有分片进行重组。每个分片的头部中都会包含**片段的偏移量和更多片段标志**，以便主机正确地按顺序重组完整的原始数据报。只有当所有片段都到达时，数据报才能被正确重组。

## 最小帧长度

以太网帧的最小长度为64字节，即便实际数据小于64字节，网络设备也会自动填充以太网帧，以满足最小长度要求。因此，在某些情况下，发送的数据报可能被自动填充以符合最小帧要求。

## 总结

通过这个实验，我们能够直观地观察到IP层的分片过程。分片的发生依赖于链路的MTU值，当数据报的大小超过MTU时，IP层将数据报分割成多个片段，以确保它能够顺利传输到目的主机。最终，目的主机将所有分片重新组装为完整的IP数据报。这种机制有效地解决了不同网络链路之间MTU值不一致的问题。
